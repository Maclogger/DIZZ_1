@page "/"
@using DIZZ_1.BackEnd
@using DIZZ_1.BackEnd.Generators
@using DIZZ_1.BackEnd.Generators.Empiric
@using DIZZ_1.BackEnd.Generators.Uniform
@using DIZZ_1.Components.Basic
@rendermode InteractiveServer

<h1 class="">Tester</h1>
<div class="container-fluid mb-5">
    <div class="row">
    </div>
    <div class="row">
        <div class="d-flex flex-wrap p-0 m-0 gap-4">
            <!-- Discrete Uniform Generator -->
            <GeneratorCard Headline="Discrete Uniform"
                           Initialize="@(() => InitializeUniformGenerator<int>(MinUniDisc, MaxUniDisc, true))"
                           Generator="MainApp.Instance.Generators.UniformDiscreteGenerator"
                           CouldBeInitialized="() => {return MinUniDisc < MaxUniDisc;}">
                <label class="mt-3">Min:</label>
                <input class="form-control" type="number" @bind="MinUniDisc" @bind:event="oninput" step="1"/>

                <label class="mt-3">Max:</label>
                <input class="form-control" type="number" @bind="MaxUniDisc" @bind:event="oninput" step="1"/>
            </GeneratorCard>

            <!-- Real Uniform Generator -->
            <GeneratorCard Headline="Real Uniform"
                           Initialize="@(() => InitializeUniformGenerator<double>(MinUniReal, MaxUniReal, false))"
                           Generator="MainApp.Instance.Generators.UniformRealGenerator"
                           CouldBeInitialized="() => {return MinUniReal < MaxUniReal;}">
                <label class="mt-3">Min:</label>
                <input class="form-control" type="number" @bind="MinUniReal" @bind:event="oninput" step="0.1"/>

                <label class="mt-3">Max:</label>
                <input class="form-control" type="number" @bind="MaxUniReal" @bind:event="oninput" step="0.1"/>
            </GeneratorCard>

            <!-- Discrete Empiric Generator -->
            <GeneratorCard Headline="Discrete Empiric"
                           Initialize="@(() => InitializeEmpiricGenerator(_empiricDiscreteRows, true))"
                           Generator="MainApp.Instance.Generators.EmpiricDiscreteGenerator"

                           CouldBeInitialized="() => CouldBeDiscreteEmpiricInitialized()">
                <div class="container">
                    @foreach (var row in _empiricDiscreteRows)
                    {
                        <EmpiricDiscreteRow
                            DistrModel="row"
                            OnRemove="@(() => RemoveRow(row, _empiricDiscreteRows))"
                            OnChange="StateHasChanged"
                            />
                    }
                    <div class="row">
                        <button class="btn btn-primary mt-2" @onclick="() => AddRow(_empiricDiscreteRows, true)">
                            Add random distribution
                        </button>
                    </div>
                </div>
            </GeneratorCard>

            <!-- Real Empiric Generator -->
            <GeneratorCard Headline="Real Empiric"
                           Initialize="@(() => InitializeEmpiricGenerator(_empiricRealRows, false))"
                           Generator="MainApp.Instance.Generators.EmpiricRealGenerator" CouldBeInitialized="() => CouldBeRealEmpiricInitialized()">
                <div class="container">
                    @foreach (var row in _empiricRealRows)
                    {
                        <EmpiricRealRow DistrModel="row" OnRemove="@(() => RemoveRow(row, _empiricRealRows))"/>
                    }
                    <div class="row">
                        <button class="btn btn-primary mt-2" @onclick="() => AddRow(_empiricRealRows, false)">
                            Add random distribution
                        </button>
                    </div>
                </div>
            </GeneratorCard>
        </div>
    </div>
</div>

@code {
    public int MinUniDisc = 0;
    public int MaxUniDisc = 100;
    public double MinUniReal = 0.0;
    public double MaxUniReal = 1.0;

    private readonly List<EmpiricDistrModel<double>> _empiricRealRows = new();
    private readonly List<EmpiricDistrModel<int>> _empiricDiscreteRows = new();

    private Generator<T> InitializeUniformGenerator<T>(T min, T max, bool isDiscrete)
    {
        if (isDiscrete)
        {
            UniformGenerator<int> generator = UniformGeneratorFactory.CreateDiscreteUniformGenerator(Convert.ToInt32(min), Convert.ToInt32(max));
            generator.EnableHistory();
            MainApp.Instance.Generators.UniformDiscreteGenerator = generator;
            return (generator as Generator<T>)!;
        }
        else
        {
            UniformGenerator<double> generator = UniformGeneratorFactory.CreateRealUniformGenerator(Convert.ToDouble(min), Convert.ToDouble(max));
            generator.EnableHistory();
            MainApp.Instance.Generators.UniformRealGenerator = generator;
            return (generator as Generator<T>)!;
        }
    }

    private Generator<T> InitializeEmpiricGenerator<T>(List<EmpiricDistrModel<T>> rows, bool isDiscrete)
    {
        var generator = new EmpiricGenerator<T>(rows);
        generator.EnableHistory();

        if (isDiscrete)
        {
            MainApp.Instance.Generators.EmpiricDiscreteGenerator = generator as EmpiricGenerator<int>;
        }
        else
        {
            MainApp.Instance.Generators.EmpiricRealGenerator = generator as EmpiricGenerator<double>;
        }

        return generator;
    }

    private void AddRow<T>(List<EmpiricDistrModel<T>> rows, bool isDiscrete)
    {
        if (isDiscrete)
        {
            int newMinimum = 0;
            if (rows.Count >= 1)
            {
                newMinimum = (rows[^1].Generator as UniformGenerator<int>)!.Max;
            }

            rows.Add(
                new EmpiricDistrModel<T>(
                    (UniformGeneratorFactory.CreateDiscreteUniformGenerator(newMinimum, newMinimum + 10) as Generator<T>)!,
                    0.5
                )
            );
        }
        else
        {
            double newMinimum = 0;
            if (rows.Count >= 1)
            {
                newMinimum = (rows[^1].Generator as UniformGenerator<double>)!.Max;
            }

            rows.Add(
                new EmpiricDistrModel<T>(
                    (UniformGeneratorFactory.CreateRealUniformGenerator(newMinimum, newMinimum + 1.0) as Generator<T>)!,
                    0.5
                )
            );
        }
    }

    private void RemoveRow<T>(EmpiricDistrModel<T> row, List<EmpiricDistrModel<T>> rows)
    {
        rows.Remove(row);
    }

    private bool CouldBeDiscreteEmpiricInitialized()
    {
        return true; // TODO
        if (_empiricDiscreteRows.Count <= 0) return false;

        double prob = 0.0;
        foreach (EmpiricDistrModel<int> row in _empiricDiscreteRows)
        {
            prob += row.Probability;
        }

        return Math.Abs(prob - 1.0) < Config.Tolerance;
    }

    private bool CouldBeRealEmpiricInitialized()
    {
        return true; // TODO
        if (_empiricRealRows.Count <= 0) return false;

        double prob = 0.0;
        foreach (EmpiricDistrModel<double> row in _empiricRealRows)
        {
            prob += row.Probability;
        }

        return Math.Abs(prob - 1.0) < Config.Tolerance;
    }

}
